name: Build

on:
  push:
    branches: [master, main]
    tags: ['v*']
  pull_request:
    branches: [master, main]

jobs:
  build:
    name: Build (Kindle)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y meson ninja-build pkg-config \
            build-essential autoconf automake libtool-bin gawk bison flex \
            texinfo help2man gperf libncurses-dev unzip wget git

      - name: Cache toolchain
        id: cache-tc
        uses: actions/cache@v4
        with:
          path: ~/x-tools/arm-kindlehf-linux-gnueabihf
          key: kindle-toolchain-v1

      - name: Build Kindle toolchain
        if: steps.cache-tc.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 https://github.com/koreader/koxtoolchain.git
          cd koxtoolchain
          ./gen-tc.sh kindlehf

      - name: Create cross-compile file
        run: |
          TC_PATH=~/x-tools/arm-kindlehf-linux-gnueabihf
          cat > /tmp/kindle-cross.txt << EOF
          [binaries]
          c = '${TC_PATH}/bin/arm-kindlehf-linux-gnueabihf-gcc'
          cpp = '${TC_PATH}/bin/arm-kindlehf-linux-gnueabihf-g++'
          ar = '${TC_PATH}/bin/arm-kindlehf-linux-gnueabihf-ar'
          strip = '${TC_PATH}/bin/arm-kindlehf-linux-gnueabihf-strip'
          pkgconfig = 'pkg-config'

          [built-in options]
          c_args = []
          cpp_args = []
          c_link_args = ['-static-libgcc', '-static-libstdc++']
          cpp_link_args = ['-static-libgcc', '-static-libstdc++']

          [host_machine]
          system = 'linux'
          cpu_family = 'arm'
          cpu = 'cortex-a9'
          endian = 'little'
          EOF

      - name: Build
        working-directory: bvg-kindle
        run: |
          export PATH=~/x-tools/arm-kindlehf-linux-gnueabihf/bin:$PATH
          meson setup --cross-file /tmp/kindle-cross.txt build_kindle
          meson compile -C build_kindle

      - name: Verify and strip binary
        run: |
          export PATH=~/x-tools/arm-kindlehf-linux-gnueabihf/bin:$PATH
          file bvg-kindle/build_kindle/bvg-kindle
          arm-kindlehf-linux-gnueabihf-strip bvg-kindle/build_kindle/bvg-kindle
          ls -la bvg-kindle/build_kindle/bvg-kindle

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: bvg-kindle-binary
          path: bvg-kindle/build_kindle/bvg-kindle

  package:
    name: Create KUAL Extension Package
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: bvg-kindle-binary
          path: bin

      - name: Create package
        run: |
          mkdir -p package/bvg
          cp bin/bvg-kindle package/bvg/
          chmod +x package/bvg/bvg-kindle
          cp bvg-kindle/extensions/bvg/config.xml package/bvg/
          cp bvg-kindle/extensions/bvg/menu.json package/bvg/
          cp bvg-kindle/extensions/bvg/bvg.sh package/bvg/
          chmod +x package/bvg/bvg.sh
          cd package && zip -r ../bvg-kual-extension.zip bvg

      - name: Upload package
        uses: actions/upload-artifact@v4
        with:
          name: bvg-kual-extension
          path: bvg-kual-extension.zip

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: package
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Download package
        uses: actions/download-artifact@v4
        with:
          name: bvg-kual-extension

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: bvg-kual-extension.zip
          generate_release_notes: true
