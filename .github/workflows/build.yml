name: Build

on:
  push:
    branches: [master, main]
    tags: ['v*']
  pull_request:
    branches: [master, main]

jobs:
  build:
    name: Build (Kindle)
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/koreader/koxtoolchain:kindlehf-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install meson
        run: |
          apt-get update
          apt-get install -y meson ninja-build pkg-config

      - name: Create cross-compile file
        run: |
          cat > /tmp/kindle-cross.txt << 'EOF'
          [binaries]
          c = 'arm-kindlehf-linux-gnueabihf-gcc'
          cpp = 'arm-kindlehf-linux-gnueabihf-g++'
          ar = 'arm-kindlehf-linux-gnueabihf-ar'
          strip = 'arm-kindlehf-linux-gnueabihf-strip'
          pkgconfig = 'pkg-config'

          [built-in options]
          c_args = []
          cpp_args = []
          c_link_args = ['-static-libgcc', '-static-libstdc++']
          cpp_link_args = ['-static-libgcc', '-static-libstdc++']

          [host_machine]
          system = 'linux'
          cpu_family = 'arm'
          cpu = 'cortex-a9'
          endian = 'little'
          EOF

      - name: Build
        working-directory: bvg-kindle
        run: |
          source /home/ko/x-compile/refs/x-compile.sh kindlehf env
          export PKG_CONFIG_PATH="${CROSS_TC_PKG_CONFIG_PATH}"
          export PKG_CONFIG_LIBDIR="${CROSS_TC_PKG_CONFIG_PATH}"
          meson setup --cross-file /tmp/kindle-cross.txt build_kindle
          meson compile -C build_kindle

      - name: Verify and strip binary
        working-directory: bvg-kindle
        run: |
          file build_kindle/bvg-kindle
          arm-kindlehf-linux-gnueabihf-strip build_kindle/bvg-kindle
          ls -la build_kindle/bvg-kindle

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: bvg-kindle-binary
          path: bvg-kindle/build_kindle/bvg-kindle

  package:
    name: Create KUAL Extension Package
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: bvg-kindle-binary
          path: bin

      - name: Create package
        run: |
          mkdir -p package/bvg
          cp bin/bvg-kindle package/bvg/
          chmod +x package/bvg/bvg-kindle
          cp bvg-kindle/extensions/bvg/config.xml package/bvg/
          cp bvg-kindle/extensions/bvg/menu.json package/bvg/
          cp bvg-kindle/extensions/bvg/bvg.sh package/bvg/
          chmod +x package/bvg/bvg.sh
          cd package && zip -r ../bvg-kual-extension.zip bvg

      - name: Upload package
        uses: actions/upload-artifact@v4
        with:
          name: bvg-kual-extension
          path: bvg-kual-extension.zip

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: package
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Download package
        uses: actions/download-artifact@v4
        with:
          name: bvg-kual-extension

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: bvg-kual-extension.zip
          generate_release_notes: true
