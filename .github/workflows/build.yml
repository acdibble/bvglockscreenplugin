name: Build

on:
  push:
    branches: [master, main]
    tags: ['v*']
  pull_request:
    branches: [master, main]

jobs:
  build:
    name: Build (Kindle)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y meson ninja-build python3 libarchive-dev libgmp-dev nettle-dev

      - name: Download Kindle toolchain
        run: |
          curl -L -o kindlehf.tar.gz https://github.com/koreader/koxtoolchain/releases/download/2025.01/kindlehf.tar.gz
          tar -xzf kindlehf.tar.gz -C $HOME

      - name: Setup Kindle SDK (sysroot with GTK+)
        run: |
          git clone --recursive --depth=1 https://github.com/KindleModding/kindle-sdk.git
          cd kindle-sdk
          ./gen-sdk.sh kindlehf

      - name: Build
        working-directory: bvg-kindle
        run: |
          export PATH=$HOME/x-tools/arm-kindlehf-linux-gnueabihf/bin:$PATH
          CROSS_FILE=$HOME/x-tools/arm-kindlehf-linux-gnueabihf/meson-cross.txt
          meson setup --cross-file "$CROSS_FILE" build_kindle
          meson compile -C build_kindle

      - name: Verify and strip binary
        run: |
          file bvg-kindle/build_kindle/bvg-kindle
          $HOME/x-tools/arm-kindlehf-linux-gnueabihf/bin/arm-kindlehf-linux-gnueabihf-strip bvg-kindle/build_kindle/bvg-kindle
          ls -la bvg-kindle/build_kindle/bvg-kindle

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: bvg-kindle-binary
          path: bvg-kindle/build_kindle/bvg-kindle

  package:
    name: Create KUAL Extension Package
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: bvg-kindle-binary
          path: bin

      - name: Create package
        run: |
          mkdir -p package/bvg
          cp bin/bvg-kindle package/bvg/
          chmod +x package/bvg/bvg-kindle
          cp bvg-kindle/extensions/bvg/config.xml package/bvg/
          cp bvg-kindle/extensions/bvg/menu.json package/bvg/
          cp bvg-kindle/extensions/bvg/bvg.sh package/bvg/
          chmod +x package/bvg/bvg.sh
          cd package && zip -r ../bvg-kual-extension.zip bvg

      - name: Upload package
        uses: actions/upload-artifact@v4
        with:
          name: bvg-kual-extension
          path: bvg-kual-extension.zip

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: package
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Download package
        uses: actions/download-artifact@v4
        with:
          name: bvg-kual-extension

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: bvg-kual-extension.zip
          generate_release_notes: true
