name: Build

on:
  push:
    branches: [master, main]
    tags: ['v*']
  pull_request:
    branches: [master, main]

jobs:
  build:
    name: Build (Kindle ARM)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Enable ARM architecture
        run: |
          sudo dpkg --add-architecture armhf
          # Restrict default sources to amd64 only (Ubuntu 24.04 uses .sources format)
          sudo sed -i 's/^Architectures:.*/Architectures: amd64/' /etc/apt/sources.list.d/ubuntu.sources 2>/dev/null || true
          if ! grep -q "^Architectures:" /etc/apt/sources.list.d/ubuntu.sources 2>/dev/null; then
            sudo sed -i '/^Types:/a Architectures: amd64' /etc/apt/sources.list.d/ubuntu.sources 2>/dev/null || true
          fi
          # Add armhf sources from ports
          echo "deb [arch=armhf] http://ports.ubuntu.com/ubuntu-ports noble main restricted universe multiverse" | sudo tee /etc/apt/sources.list.d/armhf.list
          echo "deb [arch=armhf] http://ports.ubuntu.com/ubuntu-ports noble-updates main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list.d/armhf.list
          sudo apt-get update

      - name: Install dependencies
        run: |
          sudo apt-get install -y meson ninja-build \
            gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf \
            x11proto-dev shared-mime-info \
            libgtk2.0-dev:armhf libcurl4-openssl-dev:armhf libjson-c-dev:armhf

      - name: Create cross-compile file
        run: |
          cat > /tmp/kindle-cross.txt << 'EOF'
          [binaries]
          c = 'arm-linux-gnueabihf-gcc'
          cpp = 'arm-linux-gnueabihf-g++'
          ar = 'arm-linux-gnueabihf-ar'
          strip = 'arm-linux-gnueabihf-strip'
          pkgconfig = 'pkg-config'

          [built-in options]
          c_args = ['-mfloat-abi=hard', '-mfpu=neon']
          cpp_args = ['-mfloat-abi=hard', '-mfpu=neon']

          [properties]
          pkg_config_libdir = '/usr/lib/arm-linux-gnueabihf/pkgconfig:/usr/share/pkgconfig'

          [host_machine]
          system = 'linux'
          cpu_family = 'arm'
          cpu = 'cortex-a9'
          endian = 'little'
          EOF

      - name: Build
        working-directory: bvg-kindle
        run: |
          export PKG_CONFIG_PATH=/usr/lib/arm-linux-gnueabihf/pkgconfig:/usr/share/pkgconfig:/usr/lib/pkgconfig
          meson setup --cross-file /tmp/kindle-cross.txt build_kindle
          meson compile -C build_kindle

      - name: Verify binary
        working-directory: bvg-kindle
        run: |
          file build_kindle/bvg-kindle
          arm-linux-gnueabihf-strip build_kindle/bvg-kindle
          ls -la build_kindle/bvg-kindle

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: bvg-kindle-binary
          path: bvg-kindle/build_kindle/bvg-kindle

  package:
    name: Create KUAL Extension Package
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: bvg-kindle-binary
          path: bin

      - name: Create package
        run: |
          mkdir -p package/bvg
          cp bin/bvg-kindle package/bvg/
          chmod +x package/bvg/bvg-kindle
          cp bvg-kindle/extensions/bvg/config.xml package/bvg/
          cp bvg-kindle/extensions/bvg/menu.json package/bvg/
          cp bvg-kindle/extensions/bvg/bvg.sh package/bvg/
          chmod +x package/bvg/bvg.sh
          cd package && zip -r ../bvg-kual-extension.zip bvg

      - name: Upload package
        uses: actions/upload-artifact@v4
        with:
          name: bvg-kual-extension
          path: bvg-kual-extension.zip

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: package
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Download package
        uses: actions/download-artifact@v4
        with:
          name: bvg-kual-extension

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: bvg-kual-extension.zip
          generate_release_notes: true
